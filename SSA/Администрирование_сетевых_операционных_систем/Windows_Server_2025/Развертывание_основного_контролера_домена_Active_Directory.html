<!--
title: Развертывание основного контролера домена Active Directory
description: 
published: true
date: 2025-03-11T04:53:01.087Z
tags: 
editor: ckeditor
dateCreated: 2025-02-20T23:42:24.929Z
-->

<p><strong>Цель работы: </strong>научиться развертывать контролер домена Active Directory.</p>
<figure class="image"><img src="/ssa/windows_server/activedirectory-1-1600x400.png"></figure>
<h1><span class="text-small"><strong>Краткие теоретические и учебно-методические материалы по теме лабораторной работы:</strong></span></h1>
<p style="text-align:justify;">Контроллер&nbsp;домена в компьютерных сетях, построенных на Microsoft Server, ­– сервер, управляющий областью компьютерной сети (доменом). Запускает службы Active Directory, в частности, Центр распространения ключей Kerberos (Kerberos Key Distribution Center, KDC). Чтобы разобраться, как он работает, рассмотрим основные способы управления большим количеством компьютеров. Существует два типа локальных сетей:&nbsp;</p>
<ul>
  <li style="text-align:justify;">Основанная на рабочей группе (одноранговая).</li>
  <li style="text-align:justify;">Доменная (сеть на основе управляющего сервера).</li>
</ul>
<p style="text-align:justify;">В первом случае каждый компьютер одновременно является и клиентом, и сервером. То есть, каждый пользователь может самостоятельно решать, доступ к каким файлам ему открывать и для кого именно. С одной стороны, эту сеть создать достаточно просто, но с другой, управлять ею (администрировать) бывает достаточно сложно, особенно если в сети 5 компьютеров и больше.</p>
<p style="text-align:justify;">Также, если Вам необходимо выполнить какие-либо изменения в программном обеспечении (установить систему безопасности, создать нового пользователя, инсталлировать программу или приписать сетевой принтер), придется каждый компьютер настраивать по отдельности. Одноранговая сеть может сгодиться для управления не более чем десятью устройствами.</p>
<p style="text-align:justify;">Что касается домена, в этой сети есть единый сервер (единый аппарат, в “руках” которого сосредоточена вся власть), а основные машины являются клиентами. Взаимодействие в сети между компьютерами осуществляется через контроллер домена, то есть он определяет кому, когда и куда давать доступ. Вы можете выполнять 95% задач в удаленном режиме, так как сервер имеет полные права на любом компьютере в сети. При помощи групповых политик Вы можете за несколько минут настроить все устройства в сети, не бегая от одного устройства к другому.</p>
<h2 style="text-align:justify;"><span class="text-small">Контроллер домена</span></h2>
<p style="text-align:justify;"><strong>Контроллер домена Active Directory (AD)</strong> — это сервер, который отвечает за управление доступом к ресурсам в сети и хранение информации о пользователях, компьютерах и других объектах. Основные компоненты контроллера домена AD включают:</p>
<ul>
  <li>Active Directory Database (NTDS.dit): Это основная база данных, в которой хранится информация о всех объектах в домене, таких как пользователи, группы, компьютеры и другие ресурсы. База данных использует формат, оптимизированный для быстрого поиска и управления данными.</li>
  <li>Global Catalog (Глобальный каталог): Это специальный индекс, который содержит информацию о всех объектах в лесу Active Directory. Глобальный каталог позволяет быстро находить объекты и их атрибуты, что особенно полезно в больших организациях с несколькими доменами.</li>
  <li>Domain Name System (DNS): DNS является неотъемлемой частью Active Directory, так как он обеспечивает разрешение имен для объектов в домене. Контроллеры домена обычно работают как DNS-серверы, что позволяет клиентским устройствам находить контроллеры домена и другие ресурсы в сети.</li>
  <li>Security Accounts Manager (SAM): Это компонент, который управляет учетными записями пользователей и группами. Он отвечает за аутентификацию пользователей и контроль доступа к ресурсам.</li>
  <li>Kerberos Authentication (KRB): Active Directory использует протокол Kerberos для аутентификации пользователей и компьютеров в сети. Kerberos обеспечивает безопасный обмен данными и защищает от атак, таких как перехват учетных данных.</li>
  <li>Lightweight Directory Access Protocol (LDAP): LDAP — это протокол, используемый для доступа и управления информацией в Active Directory. Он позволяет приложениям и пользователям выполнять запросы к базе данных AD для получения информации об объектах.</li>
</ul>
<p>Компоненты SAM, KRB и LDAP вместе обеспечивают<strong> &nbsp;</strong><a href="https://ru.wikipedia.org/wiki/%D0%A2%D0%B5%D1%85%D0%BD%D0%BE%D0%BB%D0%BE%D0%B3%D0%B8%D1%8F_%D0%B5%D0%B4%D0%B8%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B2%D1%85%D0%BE%D0%B4%D0%B0"><strong>SSO (Single sign-on)</strong></a>, которая организует единую точку входа, т.е. пользователю достаточно единоразово пройти процесс аутентификации (к примеру залогинится в учетную запись на компьютере), чтобы получить полный доступ к ресурсам домена (если у этой учетной записи есть на них права).</p>
<h2><span class="text-small">Этапы SSO</span></h2>
<p>Аутентификация пользователя (SAM):</p>
<ul>
  <li>Когда пользователь пытается войти в систему, его учетные данные (имя пользователя и пароль) передаются в SAM.</li>
  <li>SAM проверяет учетные данные пользователя, сравнивая их с записями в базе данных Active Directory (NTDS.dit).</li>
</ul>
<p>Получение Kerberos-токена (KRB):</p>
<ul>
  <li>После успешной аутентификации SAM передает запрос на получение Kerberos-токена (Ticket Granting Ticket, TGT) в службу Kerberos.</li>
  <li>Служба Kerberos проверяет учетные данные и, если они действительны, выдает TGT, который шифруется с использованием ключа, основанного на пароле пользователя.</li>
  <li>TGT содержит информацию о пользователе и сроке действия токена.</li>
</ul>
<p>Запрос доступа к ресурсам (KRB):</p>
<ul>
  <li>Когда пользователь пытается получить доступ к определенному ресурсу (например, к приложению или серверу), он использует свой TGT для запроса сервисного билета (Service Ticket) у службы Kerberos.</li>
  <li>Служба Kerberos проверяет TGT и, если он действителен, выдает сервисный билет, который шифруется с использованием ключа, связанного с целевым ресурсом.</li>
</ul>
<p>Доступ к ресурсу (LDAP):</p>
<ul>
  <li>Пользователь отправляет сервисный билет вместе с запросом на доступ к ресурсу (например, к приложению или серверу).</li>
  <li>Ресурс (или сервер приложения) использует LDAP для проверки сервисного билета, чтобы убедиться, что он действителен и что пользователь <strong>имеет необходимые права доступа</strong>.</li>
  <li>Если проверка успешна, пользователь получает доступ к ресурсу без необходимости повторного ввода учетных данных.</li>
</ul>
<h3>Резюме</h3>
<ul>
  <li>SAM отвечает за аутентификацию пользователя.</li>
  <li>Kerberos (KRB) управляет выдачей TGT и сервисных билетов, обеспечивая безопасный обмен данными и аутентификацию между пользователем и ресурсами.</li>
  <li>LDAP используется для проверки прав доступа и получения информации о пользователе и его атрибутах при доступе к ресурсам.</li>
</ul>
<h1><span class="text-small"><strong>Задания для практической работы:</strong></span></h1>
<p>Установка роли AD на Windows Server налагает 3 требования:</p>
<ul>
  <li>Статический IP-адрес, как минимум на 1 интерфейсе</li>
  <li>Установленный пароль на учетную запись "Администратор"</li>
  <li>Понятный и уникальный hostname (имя компьютера)</li>
</ul>
<p>Если вы делали все предыдущие практические работы, то у вас эти требования уже соблюдены.</p>
<h2><span class="text-small">Установка роли Active Directory</span></h2>
<p>Открываем консоль Диспетчер серверов, выбираем <strong>Управление</strong> -&gt; <strong>Добавить роли и компоненты</strong>, находим и отмечаем роль</p>
<figure class="image image_resized" style="width:68.02%;"><img src="/ssa/windows_server/ws_ad1.png"></figure>
<p>Дождитесь установки роли</p>
<figure class="image image_resized" style="width:68.01%;"><img src="/ssa/windows_server/ws_ad2.png"></figure>
<h2><span class="text-small">Настройка роли Active Directory</span></h2>
<p>Нажмите на «Повысить роль этого сервера до уровня контроллера домена» (Promote server to domain controller). По сути, это мастер конфигурации развертывания Active Directory, который поможет вам создать первый лес в Active Directory.</p>
<figure class="image"><img src="/ssa/windows_server/ws_ad3.png"></figure>
<p>В разделе «Конфигурация развертывания», включите опцию «Добавить новый лес», а затем введите имя домена ssa.local и нажмите Далее.</p>
<figure class="image image_resized" style="width:68.07%;"><img src="/ssa/windows_server/ws_ad4.png"></figure>
<p>Теперь переходим к Параметрам контроллера домена.&nbsp;</p>
<figure class="image image_resized" style="width:68.04%;"><img src="/ssa/windows_server/ws_ad5.png"></figure>
<p>Введите пароль P@ssw0rd.</p>
<p>Режим работы домена и режим работы леса в Active Directory определяют функциональные возможности и совместимость различных версий Windows Server, которые используются в инфраструктуре.</p>
<ul>
  <li><strong>Режим работы домена </strong>определяет, какие функции доступны в конкретном домене Active Directory. Он устанавливается на уровне контроллера домена и может быть изменен только при выполнении определенных условий.</li>
  <li><strong>Режим работы леса</strong>, в свою очередь, определяет функциональные возможности для всех доменов в лесу Active Directory. Он устанавливается на уровне леса и влияет на все домены, входящие в его состав.</li>
</ul>
<figure class="image image_resized" style="width:68.04%;"><img src="/ssa/windows_server/ws_ad6.png"></figure>
<p>Не обращаем внимание на ошибку и нажимаем Далее.</p>
<figure class="image image_resized" style="width:68.04%;"><img src="/ssa/windows_server/ws_ad7.png"></figure>
<p>Определяем уже знакомое вам NetBIOS имя, для домена и всех его участников.</p>
<p>Страница Пути позволяет переопределить расположение папок по умолчанию для базы данных AD DS (NTDS.dit), файлов журнала и SYSVOL</p>
<figure class="image image_resized" style="width:68.09%;"><img src="/ssa/windows_server/ws_ad8.png"></figure>
<figure class="image image_resized" style="width:68.04%;"><img src="/ssa/windows_server/ws_ad9.png"></figure>
<p>Далее идет проверка предварительных требования для развёртывания доменного контроллера, у вас не должно быть ошибок, только 1 предупреждение о невозможности делегирования DNS.</p>
<p>Если у вас имеется ошибка, закройте Мастер настройки доменных служб Active Directory, исправьте ошибку и начните настройку заново.</p>
<figure class="image image_resized" style="width:68.04%;"><img src="/ssa/windows_server/ws_ad10.png"></figure>
<p>Нажмите <strong>Установить.</strong></p>
<p>Дождитесь установки и перезагрузите WS. Перезарузка может занять до 10 минут, так как устанавливается большое количество компонентов.</p>
<h2><span class="text-small">Особенности входа</span></h2>
<p>После перезагрузки вы заметите что перед именем учетной записи теперь идет доменная часть:</p>
<figure class="image image_resized" style="width:66.12%;"><img src="/ssa/windows_server/ws_ad11.png"></figure>
<p>По умолчанию доменной частью будет имя нашего основного домена, но что делать если в нашем лесу несколько доменов?<br>В таком случае, нужно так же указать доменную часть перед именем учетной записи:</p>
<figure class="image image_resized" style="width:45.91%;"><img src="/ssa/windows_server/ws_ad12.png"></figure>
<p>Так же, бывает надобность зайти не под доменным пользователем, а под локальным (к примеру, в случае недоступности домена).&nbsp;<br>В таком случае вы должны указать имя_компьютера/имя_локального_пользователя, например, DC1\admin (так же можно указывать .\admin).</p>
<h2><span class="text-small">Учетная запись администратора</span></h2>
<p>По умолчанию для входа мы используем учетную запись Администратор. Такой подход уместен во время развертывания AD, и использования WS в тестовой среде, но в “продакшене” так не делают.&nbsp;</p>
<p>Для каждого системного администратора должна быть создана своя учетная запись, с необходимыми правами.<br>Это позволит повысить безопасность системы, так как в случае ошибки конфигурирования сервера в логах будет видно кто и когда ее допустил.</p>
<p>Для начала нам нужно создать свою учетную запись.</p>
<p>Открываем <strong>Пользователи и компьютеры Active Directory</strong></p>
<figure class="image image_resized" style="width:48.54%;"><img src="/ssa/windows_server/ws_ad13.png"></figure>
<p>Далее создайте подразделение SSA, а нем подразделения admins, users. В подразделении admins создайте пользователя ukrtb с паролем P@ssw0rd, это и будет наша админская учетная запись.&nbsp;</p>
<figure class="image image_resized" style="width:25.55%;"><img src="/ssa/windows_server/ws_ad14.png"></figure>
<figure class="image image_resized" style="width:46.61%;"><img src="/ssa/windows_server/ws_ad15.png"></figure>
<figure class="image image_resized" style="width:46.73%;"><img src="/ssa/windows_server/ws_ad16.png"></figure>
<p>В дальнейшем такое распределение учетных записей на подразделения упростит создание AD GPO политик.</p>
<p>Теперь нужно добавить эту учетную запись во все админские группы, в противном случае WS не даст нам отключить учетную запись <strong>Администратор</strong>.</p>
<p>Тут есть 2 варианта, выдать права напрямую учетной записи, либо создать группу admins, эту группу сделать членом всех админских групп, а потом сделать пользователя ukrtb членом группы admins. Второй вариант более предпочтительный в случае большого количества системных администраторов в штате, а первый просто проще.</p>
<p>Давайте пойдем первым путем. Для этого откройте пользователя и перейдите на вкладку <strong>Член групп </strong>и нажмите<strong> Добавить</strong>.</p>
<figure class="image image_resized" style="width:40.54%;"><img src="/ssa/windows_server/ws_ad17.png"></figure>
<p>Затем нажмите<strong> Дополнительно → Поиск,</strong> у вас появится список всех групп, нам нужно добавить 5 главных групп, являясь членом которых пользователь получит полный доступ к домену:</p>
<ul>
  <li>Администраторы</li>
  <li>Администраторы домена</li>
  <li>Администраторы предприятия</li>
  <li>Администраторы схемы</li>
  <li>Владельцы-создатели групповой политики</li>
</ul>
<p>Чтобы одновременно их добавить зажмите Ctrl и выберите все группы через ЛКМ.</p>
<p>После того как вы добавите группы, отключите учетную запись Администратор.</p>
<figure class="image image_resized" style="width:66.03%;"><img src="/ssa/windows_server/ws_ad18.png"></figure>
<p>В отчет приложите скриншоты всех этих действий.</p>
<h1><span class="text-small">Контрольные вопросы</span></h1>
<ol>
  <li>Что-нибудь спрошу</li>
  <li>Что-нибудь спрошу</li>
  <li>Что-нибудь спрошу</li>
  <li>Что-нибудь спрошу</li>
  <li>Что-нибудь спрошу</li>
</ol>
